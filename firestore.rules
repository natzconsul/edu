rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidPhone(phone) {
      return phone.size() >= 10 && phone.size() <= 20;
    }
    
    function isValidBookingData(data) {
      return data.keys().hasAll([
        'name', 'email', 'phone', 'citizenship', 'residence', 
        'education', 'desired', 'slotKey', 'slotLabel', 'monthKey', 'bookedAt'
      ]) &&
      // Name validation
      data.name is string &&
      data.name.size() > 0 &&
      data.name.size() <= 100 &&
      // Email validation
      data.email is string &&
      isValidEmail(data.email) &&
      // Phone validation
      data.phone is string &&
      isValidPhone(data.phone) &&
      // Other required fields
      data.citizenship is string &&
      data.citizenship.size() > 0 &&
      data.residence is string &&
      data.residence.size() > 0 &&
      data.education is string &&
      data.education.size() > 0 &&
      data.desired is string &&
      data.desired.size() > 0 &&
      // Slot information
      data.slotKey is string &&
      data.slotKey.size() > 0 &&
      data.slotLabel is string &&
      data.slotLabel.size() > 0 &&
      // Month key format validation (YYYY-M or YYYY-MM)
      data.monthKey is string &&
      data.monthKey.matches('^[0-9]{4}-[0-9]{1,2}$') &&
      // Timestamp validation (prevent backdating/future dating)
      data.bookedAt is timestamp &&
      data.bookedAt >= request.time - duration.value(5, 'm') &&
      data.bookedAt < request.time + duration.value(1, 'h');
    }
    
    // ============================================
    // BOOKINGS COLLECTION
    // ============================================
    
    match /bookings/{bookingId} {
      // Allow reading bookings for availability checking (race condition prevention)
      // Note: Consider restricting this to only read slotKey field if privacy is a concern
      allow read: if true;
      
      // Allow creating bookings with valid data
      allow create: if isValidBookingData(request.resource.data);
      
      // Prevent updates and deletes (bookings are immutable)
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // CONFIG COLLECTION (Availability Schedule)
    // ============================================
    
    match /config/{configId} {
      // Allow public read access for availability schedule
      allow read: if true;
      
      // SECURITY: Only allow writes from Firebase Console/Admin SDK
      // Set to false to prevent client-side modifications
      allow write: if false;
    }
    
    // ============================================
    // DEFAULT DENY ALL
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
